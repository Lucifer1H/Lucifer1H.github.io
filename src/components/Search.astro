{/* Search Trigger Button */}
<button 
  id="search-trigger" 
  class="ml-4 p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 focus:outline-none transition-all duration-200 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 active:scale-90"
  aria-label="Open Search"
>
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
  </svg>
</button>

{/* Search Modal Overlay */}
<div id="search-modal" class="fixed inset-0 z-[100] hidden" aria-hidden="true" role="dialog">
  {/* Backdrop */}
  <div id="search-backdrop" class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
  
  {/* Modal Content */}
  <div id="search-content" class="relative w-full max-w-2xl mx-auto mt-20 sm:mt-24 px-4 opacity-0 scale-95 transition-all duration-300 ease-out transform">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 overflow-hidden">
      
      {/* Dev Mode Placeholder */}
      {import.meta.env.DEV && (
        <div class="p-6 text-center text-gray-500 dark:text-gray-400">
          <p class="mb-2">üîç Search is available in production builds.</p>
          <p class="text-xs opacity-70">(Pagefind requires a static build to generate the index)</p>
        </div>
      )}

      {/* Production Search Container */}
      {!import.meta.env.DEV && <div id="search-container" class="p-4 sm:p-6 min-h-[100px]"></div>}
      
    </div>
    
    <button id="close-search" class="absolute -top-10 right-4 text-white hover:text-gray-200 sm:hidden">
      Close
    </button>
  </div>
</div>

{ !import.meta.env.DEV && (
  <>
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js" is:inline></script>
  </>
)}

<script is:inline>
  function setupSearch() {
    const trigger = document.getElementById('search-trigger');
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('search-backdrop');
    const content = document.getElementById('search-content');
    const closeBtn = document.getElementById('close-search');

    if (!trigger || !modal) {
      console.error('Search elements not found');
      return;
    }

    function openModal() {
      console.log('Opening search modal');
      modal.classList.remove('hidden');
      // Force reflow
      void modal.offsetWidth;
      
      backdrop.classList.remove('opacity-0');
      content.classList.remove('opacity-0', 'scale-95');
      content.classList.add('opacity-100', 'scale-100');
      
      // Focus input if available
      setTimeout(() => {
        const input = document.querySelector('.pagefind-ui__search-input');
        if (input) input.focus();
      }, 100);
    }

    function closeModal() {
      console.log('Closing search modal');
      backdrop.classList.add('opacity-0');
      content.classList.remove('opacity-100', 'scale-100');
      content.classList.add('opacity-0', 'scale-95');
      
      setTimeout(() => {
        modal.classList.add('hidden');
        // Optional: Clear input on close
        const input = document.querySelector('.pagefind-ui__search-input');
        if (input) input.value = '';
      }, 300);
    }

    // Clean up old listeners to prevent duplicates if re-running
    trigger.onclick = openModal;
    backdrop.onclick = closeModal;
    if (closeBtn) closeBtn.onclick = closeModal;

    // Close on Escape key
    document.onkeydown = (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    };

    // Initialize Pagefind UI if needed
    if (typeof PagefindUI !== 'undefined') {
       // Check if already initialized to avoid duplicates
       const searchContainer = document.getElementById('search-container');
       if (searchContainer && searchContainer.innerHTML.trim() === '') {
          new PagefindUI({ 
            element: "#search-container", 
            showSubResults: true,
            showImages: false 
          });

          // Wait for DOM to update then modify form
          setTimeout(() => {
            const forms = document.querySelectorAll('.pagefind-ui__form');
            forms.forEach(form => {
              form.style.display = 'flex';
              form.style.alignItems = 'center';
              form.style.gap = '8px';

              // Check if cancel btn already exists
              if (!form.querySelector('.custom-cancel-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.innerText = 'Cancel';
                cancelBtn.className = 'custom-cancel-btn text-blue-600 dark:text-blue-400 font-medium text-sm px-2 hover:opacity-80 transition-opacity';
                cancelBtn.onclick = (e) => {
                  e.preventDefault(); 
                  closeModal();
                };
                form.appendChild(cancelBtn);
              }
            });

            // Input logic
            const input = document.querySelector('.pagefind-ui__search-input');
            if (input) {
              const handleInput = (e) => {
                if (e.target.value.length > 0) {
                  input.closest('form')?.classList.add('has-text');
                } else {
                  input.closest('form')?.classList.remove('has-text');
                }
              };
              input.addEventListener('input', handleInput);
            }
          }, 100);
       }
    }
  }

  // Run on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupSearch);
  } else {
    setupSearch();
  }
</script>

<style is:global>
  @reference "../styles/global.css";
  
  /* Reset and style Pagefind UI for the modal */
  #search-container .pagefind-ui__search-input {
    @apply bg-gray-100 dark:bg-gray-800 border-none text-gray-900 dark:text-gray-100 placeholder-gray-400 text-base w-full rounded-xl pl-10 pr-4 py-3 focus:ring-0 shadow-inner appearance-none;
  }
  
  /* Custom Icon Logic */
  #search-container .pagefind-ui__form::before {
    @apply absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none z-10 content-[''];
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239CA3AF'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3F%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    transition: opacity 0.2s;
  }
  
  /* Hide icon when input has text (using placeholder-shown trick or JS class) */
  #search-container .pagefind-ui__search-input:not(:placeholder-shown) ~ .pagefind-ui__form::before {
     /* This sibling selector won't work easily because input is inside form. 
        We rely on the input styling itself or the form class we added in JS.
     */
  }

  /* Make sure form has relative positioning for the icon */
  #search-container .pagefind-ui__form {
    @apply relative flex-1 w-full !important;
  }
  
  /* Enforce vertical stacking for the main container */
  #search-container .pagefind-ui {
    @apply flex flex-col gap-4 w-full !important;
  }

  /* Reset drawer positioning to flow naturally in the flex column */
  #search-container .pagefind-ui__drawer {
    @apply border-t border-gray-100 dark:border-gray-800 mt-4 max-h-[60vh] overflow-y-auto w-full !important;
    position: static !important; /* Override potential absolute positioning */
  }

  /* Hide default clear button */
  #search-container .pagefind-ui__search-clear {
    display: none !important;
  }

  /* Hide Pagefind's default icon if they use one */
  #search-container .pagefind-ui__search-input::-webkit-search-decoration,
  #search-container .pagefind-ui__search-input::-webkit-search-cancel-button,
  #search-container .pagefind-ui__search-input::-webkit-search-results-button,
  #search-container .pagefind-ui__search-input::-webkit-search-results-decoration {
    display: none;
  }
  
  #search-container .pagefind-ui__drawer {
    @apply border-t border-gray-100 dark:border-gray-800 mt-4 max-h-[60vh] overflow-y-auto;
  }

  #search-container .pagefind-ui__result {
    @apply border-b border-gray-50 dark:border-gray-800/50 py-3 px-2 first:pt-0;
  }

  /* Make mark text (highlighted) nice */
  #search-container mark {
    @apply bg-yellow-200 dark:bg-yellow-500/30 text-gray-900 dark:text-gray-100 rounded px-0.5;
  }
</style>
