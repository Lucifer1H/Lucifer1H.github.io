---
// Font imports removed - relying on global tailwind fonts
---

{/* Trigger Button */}
<button 
  id="search-trigger"
  class="ml-4 p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
  aria-label="Search"
>
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
  </svg>
</button>

{/* Modal Overlay */}
<dialog 
  id="search-dialog" 
  class="fixed inset-0 z-[100] w-full h-full bg-transparent p-0 m-0 backdrop:bg-gray-900/50 backdrop:backdrop-blur-sm"
>
  <div class="w-full h-full flex flex-col items-center pt-20 px-4 pointer-events-none">
    {/* Modal Content - Click events enabled here */}
    <div 
      class="w-full max-w-2xl bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 overflow-hidden pointer-events-auto transform transition-all scale-95 opacity-0"
      id="search-content"
    >
      {/* Dev Mode Placeholder */}
      {import.meta.env.DEV && (
        <div class="p-8 text-center text-gray-500">
           Running in Dev Mode. Build for Search.
        </div>
      )}

      {/* Pagefind Container */}
      {!import.meta.env.DEV && (
        <div id="pagefind-root" class="p-4"></div>
      )}
    </div>
  </div>
</dialog>

{/* Load Pagefind Assets if Prod */}
{!import.meta.env.DEV && (
  <>
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js" is:inline></script>
  </>
)}

<script>
  const dialog = document.getElementById('search-dialog') as HTMLDialogElement;
  const trigger = document.getElementById('search-trigger');
  const content = document.getElementById('search-content');

  // Open Logic
  trigger?.addEventListener('click', () => {
    if (typeof dialog.showModal === 'function') {
      dialog.showModal();
      // Animation entry
      requestAnimationFrame(() => {
        content?.classList.remove('scale-95', 'opacity-0');
        content?.classList.add('scale-100', 'opacity-100');
      });
      // Focus Input
      setTimeout(() => {
        const input = dialog.querySelector('input');
        if (input) input.focus();
      }, 50);
    } else {
      console.warn("Dialog API not supported");
    }
  });

  // Close Logic
  function closeDialog() {
    content?.classList.remove('scale-100', 'opacity-100');
    content?.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
      dialog.close();
      // Clear input on close for fresh start next time
      const input = dialog.querySelector('input');
      if (input) input.value = '';
      // Also clear results if possible (optional)
    }, 200);
  }

  // Click backdrop to close
  dialog?.addEventListener('click', (e) => {
    const rect = dialog.getBoundingClientRect();
    // Check if click is on backdrop (dialog itself)
    if (e.target === dialog) {
      closeDialog();
    }
  });

  // Init Pagefind
  if (!import.meta.env.DEV && typeof PagefindUI !== 'undefined') {
    // Wait for DOM
    document.addEventListener('DOMContentLoaded', () => {
      new PagefindUI({
        element: "#pagefind-root",
        showSubResults: true,
        showImages: false
      });

      // Customize UI after init
      const checkParams = setInterval(() => {
        const form = document.querySelector('#pagefind-root .pagefind-ui__form');
        if (form) {
          clearInterval(checkParams);
          
          // 1. Append Cancel Button
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'Cancel';
          cancelBtn.type = 'button';
          cancelBtn.className = 'ml-3 text-blue-600 dark:text-blue-400 font-medium text-sm hover:opacity-80';
          cancelBtn.onclick = (e) => {
            e.preventDefault();
            closeDialog();
          };
          form.appendChild(cancelBtn);

          // 2. Input Listeners (Icon toggle)
          const input = form.querySelector('input');
          if (input) {
            input.placeholder = 'Search...';
            input.addEventListener('input', (e: any) => {
               if (e.target.value.length > 0) form.classList.add('has-text');
               else form.classList.remove('has-text');
            });
          }
        }
      }, 50);
    });
  }
</script>

<style is:global>
  /* Base Styles for Pagefind Container */
  #pagefind-root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #3b82f6;
    --pagefind-ui-text: #374151;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #f3f4f6;
    --pagefind-ui-tag: #f3f4f6;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0.75rem;
    --pagefind-ui-image-border-radius: 0.75rem;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: 'Inter', sans-serif;
  }

  /* Dark Mode Variables */
  :root.dark #pagefind-root {
    --pagefind-ui-text: #e5e7eb;
    --pagefind-ui-background: #111827;
    --pagefind-ui-border: #1f2937;
    --pagefind-ui-tag: #1f2937;
  }

  /* 
   * CRITICAL LAYOUT OVERRIDES 
   * Making sure Form is Row and Drawer is Column/Block
   */
  #pagefind-root .pagefind-ui {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;
  }

  /* Form: Input + Cancel Button */
  #pagefind-root .pagefind-ui__form {
    display: flex;
    flex-direction: row;
    align-items: center;
    width: 100%;
    position: relative;
  }
  
  /* Input Field Styling */
  #pagefind-root .pagefind-ui__search-input {
    flex: 1;
    background-color: #f3f4f6 !important; /* bg-gray-100 */
    border: none !important;
    padding: 0.75rem 1rem 0.75rem 2.5rem !important; /* Left padding for icon */
    border-radius: 0.75rem !important;
    font-size: 1rem !important;
    line-height: normal !important;
    color: #1f2937 !important;
    width: 100% !important;
    box-shadow: none !important;
  }
  :root.dark #pagefind-root .pagefind-ui__search-input {
    background-color: #1f2937 !important; /* bg-gray-800 */
    color: #f3f4f6 !important;
  }
  
  /* Focus State */
  #pagefind-root .pagefind-ui__search-input:focus {
    outline: 2px solid rgba(59, 130, 246, 0.5) !important;
  }

  /* Clear Button (Hidden) */
  #pagefind-root .pagefind-ui__search-clear {
    display: none !important;
  }

  /* Custom Search Icon (Pseudo-element) */
  #pagefind-root .pagefind-ui__form::before {
    content: '';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239CA3AF'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3F%3E%3C/path%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    pointer-events: none;
    z-index: 10;
  }

  /* Hide Icon when typing (optional specific logic removed for simplicity, 
     but kept the left padding so icon is always visible like Apple Spotlight) 
  */

  /* Results Drawer */
  #pagefind-root .pagefind-ui__drawer {
    width: 100% !important;
    position: static !important;
    box-shadow: none !important;
    background: transparent !important;
    margin-top: 0 !important;
    max-height: 60vh;
    overflow-y: auto;
  }

  /* Result Item */
  #pagefind-root .pagefind-ui__result {
    border-bottom: 1px solid #f3f4f6 !important;
    padding: 0.75rem 0 !important;
  }
  :root.dark #pagefind-root .pagefind-ui__result {
    border-color: #1f2937 !important;
  }

  /* Remove default shadows overlapping */
  #pagefind-root .pagefind-ui__result-thumb { 
    display: none; /* User previously said showImages: false, double check */
  }
</style>
